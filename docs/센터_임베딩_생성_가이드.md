# ì„¼í„° ì„ë² ë”© ìƒì„± ê°€ì´ë“œ

> **Phase 2 Sprint 5: í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ ì‹œìŠ¤í…œ - ì„¼í„° ì„ë² ë”© ë°°ì¹˜ ì‘ì—…**

ì´ ë¬¸ì„œëŠ” Qdrant ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì— ì„¼í„° ì„ë² ë”©ì„ ìƒì„±í•˜ê³  ì €ì¥í•˜ëŠ” ê³¼ì •ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

---

## ğŸ“š ëª©ì°¨

1. [ì„ë² ë”©ì´ë€?](#ì„ë² ë”©ì´ë€)
2. [ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­](#ì‚¬ì „-ì¤€ë¹„-ì‚¬í•­)
3. [Step 1: Qdrant ì´ˆê¸°í™”](#step-1-qdrant-ì´ˆê¸°í™”)
4. [Step 2: ì„¼í„° ì„ë² ë”© ìƒì„±](#step-2-ì„¼í„°-ì„ë² ë”©-ìƒì„±)
5. [ë¬¸ì œ í•´ê²°](#ë¬¸ì œ-í•´ê²°)
6. [ì¶”ê°€ ì‘ì—…](#ì¶”ê°€-ì‘ì—…)

---

## ì„ë² ë”©ì´ë€?

### ê°œë…

**ì„ë² ë”©(Embedding)**ì€ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì¹˜ ë²¡í„°ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

```
"ìš°ìš¸ì¦ ìƒë‹´ì´ í•„ìš”í•´ìš”"
  â†“ OpenAI Embedding
[0.123, -0.456, 0.789, ..., 0.234]  (3072ê°œ ìˆ«ì)
```

### ì™œ í•„ìš”í•œê°€?

1. **ì˜ë¯¸ë¡ ì  ìœ ì‚¬ë„ ê³„ì‚°**: ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­ì„ ë„˜ì–´ **ì˜ë¯¸ê°€ ë¹„ìŠ·í•œ** ì„¼í„°ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   ```
   ì‚¬ìš©ì ì¿¼ë¦¬: "ë§ˆìŒì´ í˜ë“¤ì–´ìš”"
   â†“
   ë§¤ì¹­ë˜ëŠ” ì„¼í„°: "ìš°ìš¸ì¦ ì „ë¬¸ ìƒë‹´", "ì •ì‹ ê±´ê°• ì‹¬ë¦¬ì¹˜ë£Œ" (í‚¤ì›Œë“œê°€ ë‹¬ë¼ë„ ì˜ë¯¸ê°€ ìœ ì‚¬)
   ```

2. **í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ**: Phase 1 ê·œì¹™ ê¸°ë°˜ ì ìˆ˜(70%)ì™€ Phase 2 ì˜ë¯¸ë¡ ì  ìœ ì‚¬ë„(30%)ë¥¼ ê²°í•©í•˜ì—¬ ë” ì •í™•í•œ ì¶”ì²œ

3. **ìì—°ì–´ ê²€ìƒ‰**: ì‚¬ìš©ìê°€ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ê²€ìƒ‰í•´ë„ ì ì ˆí•œ ì„¼í„° ì¶”ì²œ ê°€ëŠ¥

### ì–´ë–»ê²Œ ë™ì‘í•˜ë‚˜?

```
ì„¼í„° ì •ë³´ (í…ìŠ¤íŠ¸) â†’ OpenAI API â†’ ì„ë² ë”© ë²¡í„° â†’ Qdrant ì €ì¥
ì‚¬ìš©ì ì¿¼ë¦¬ (í…ìŠ¤íŠ¸) â†’ OpenAI API â†’ ì¿¼ë¦¬ ë²¡í„° â†’ Qdrant ê²€ìƒ‰ (ìœ ì‚¬ë„ ê³„ì‚°)
```

---

## ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ë°°ì¹˜ ì‘ì—…ì„ ì‹¤í–‰í•˜ê¸° ì „ì— ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] **OpenAI API í‚¤ ë°œê¸‰ ì™„ë£Œ** (https://platform.openai.com/api-keys)
- [ ] **Qdrant ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘** (`docker ps | grep qdrant`)
- [ ] **MySQL ë°ì´í„°ë² ì´ìŠ¤ì— ì„¼í„° ë°ì´í„° ì¡´ì¬** (`SELECT COUNT(*) FROM Center;`)
- [ ] **í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ** (`.env` íŒŒì¼)
- [ ] **Node.js íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ** (`npm install` or `pnpm install`)

### í™˜ê²½ ë³€ìˆ˜ í™•ì¸

`backend/.env` íŒŒì¼ì— ë‹¤ìŒ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸:

```bash
# OpenAI Configuration
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx  # â­ í•„ìˆ˜

# Qdrant Configuration
QDRANT_URL=http://localhost:6333      # ê°œë°œ í™˜ê²½
# QDRANT_URL=http://qdrant:6333      # í”„ë¡œë•ì…˜ (Docker Compose)

# Optional: ê¸°ë³¸ê°’ì´ ìˆì§€ë§Œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
OPENAI_EMBEDDING_MODEL=text-embedding-3-large
QDRANT_COLLECTION_NAME=centers
QDRANT_VECTOR_SIZE=3072
```

### Docker ì»¨í…Œì´ë„ˆ í™•ì¸

Qdrantê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸:

```bash
docker ps | grep qdrant
```

**ì˜ˆìƒ ì¶œë ¥**:
```
mindconnect-qdrant-dev   qdrant/qdrant:v1.7.4   Up 5 minutes   0.0.0.0:6333->6333/tcp
```

ë§Œì•½ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë¼ë©´:

```bash
# ê°œë°œ í™˜ê²½
docker-compose -f docker-compose.dev.yml up -d qdrant

# í”„ë¡œë•ì…˜
docker-compose up -d qdrant
```

---

## Step 1: Qdrant ì´ˆê¸°í™”

### ëª©ì 

Qdrantì— `centers` ì»¬ë ‰ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ ì»¬ë ‰ì…˜ì€ ì„¼í„° ì„ë² ë”© ë²¡í„°ë¥¼ ì €ì¥í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

### ì‹¤í–‰ ë°©ë²•

```bash
cd backend
node src/scripts/initQdrant.js
```

### ì˜ˆìƒ ì¶œë ¥ (ì •ìƒ)

```
ğŸš€ Qdrant ì´ˆê¸°í™” ì‹œì‘...

1ï¸âƒ£  Qdrant ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...
âœ… Qdrant ì—°ê²° ì„±ê³µ: http://localhost:6333

2ï¸âƒ£  ì»¬ë ‰ì…˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘...
âœ… ì»¬ë ‰ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ìƒˆë¡œ ìƒì„± ê°€ëŠ¥)

3ï¸âƒ£  ì»¬ë ‰ì…˜ ìƒì„± ì¤‘...
   - ì´ë¦„: centers
   - ë²¡í„° ì°¨ì›: 3072
   - ê±°ë¦¬ ë©”íŠ¸ë¦­: Cosine

âœ… ì»¬ë ‰ì…˜ ìƒì„± ì„±ê³µ

4ï¸âƒ£  ì»¬ë ‰ì…˜ ì •ë³´ ì¡°íšŒ ì¤‘...
ğŸ“Š ì»¬ë ‰ì…˜ ì •ë³´:
   - ì´ ë²¡í„° ìˆ˜: 0
   - ë²¡í„° ì°¨ì›: 3072
   - ê±°ë¦¬ ë©”íŠ¸ë¦­: Cosine

âœ… Qdrant ì´ˆê¸°í™” ì™„ë£Œ!
```

### ì˜ˆìƒ ì¶œë ¥ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°)

```
ğŸš€ Qdrant ì´ˆê¸°í™” ì‹œì‘...

1ï¸âƒ£  Qdrant ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...
âœ… Qdrant ì—°ê²° ì„±ê³µ: http://localhost:6333

2ï¸âƒ£  ì»¬ë ‰ì…˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘...
âš ï¸  ì»¬ë ‰ì…˜ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤

ğŸ“Š í˜„ì¬ ì»¬ë ‰ì…˜ ì •ë³´:
   - ì´ ë²¡í„° ìˆ˜: 50
   - ë²¡í„° ì°¨ì›: 3072
   - ê±°ë¦¬ ë©”íŠ¸ë¦­: Cosine

ğŸ’¡ ì´ˆê¸°í™” ë°©ë²•:
   1. ê¸°ì¡´ ì»¬ë ‰ì…˜ ìœ ì§€: ì•„ë¬´ ì‘ì—…ë„ í•„ìš” ì—†ìŠµë‹ˆë‹¤
   2. ì»¬ë ‰ì…˜ ì¬ìƒì„±: --reset í”Œë˜ê·¸ ì‚¬ìš©
      â†’ node src/scripts/initQdrant.js --reset
```

### ì»¬ë ‰ì…˜ ì¬ìƒì„± (ì˜µì…˜)

ê¸°ì¡´ ì»¬ë ‰ì…˜ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´:

```bash
node src/scripts/initQdrant.js --reset
```

âš ï¸ **ì£¼ì˜**: ê¸°ì¡´ì— ì €ì¥ëœ ëª¨ë“  ì„ë² ë”© ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!

---

## Step 2: ì„¼í„° ì„ë² ë”© ìƒì„±

### ëª©ì 

MySQL ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ì„¼í„° ì •ë³´ë¥¼ ì½ì–´ì„œ OpenAI ì„ë² ë”©ì„ ìƒì„±í•˜ê³ , Qdrantì— ì €ì¥í•©ë‹ˆë‹¤.

### ì‹¤í–‰ ë°©ë²•

```bash
cd backend
node src/cron/centerEmbeddingBatch.js
```

### ì²˜ë¦¬ ê³¼ì •

1. **ì„¼í„° ì¡°íšŒ**: MySQLì—ì„œ `isActive = true`ì¸ ì„¼í„° + í”„ë¡œê·¸ë¨ ì¡°íšŒ
2. **í…ìŠ¤íŠ¸ ìƒì„±**: ì„¼í„° ì •ë³´ë¥¼ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
   ```
   ì„¼í„°ëª…: ì„œìš¸ì‹œë§ˆìŒê±´ê°•ë³µì§€ì„¼í„°
   ì„¤ëª…: ì„œìš¸ì‹œë¯¼ì˜ ì •ì‹ ê±´ê°• ì¦ì§„ì„ ìœ„í•œ í†µí•© ì„œë¹„ìŠ¤
   ëŒ€ìƒ: ìš°ìš¸ì¦, ë¶ˆì•ˆì¥ì• , ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ í•„ìš”í•œ ì‹œë¯¼
   ì „ë¬¸ ë¶„ì•¼: ìš°ìš¸ì¦, ë¶ˆì•ˆì¥ì• 
   í”„ë¡œê·¸ë¨: ê°œì¸ìƒë‹´: 1:1 ì‹¬ë¦¬ìƒë‹´, ì§‘ë‹¨ìƒë‹´: ìš°ìš¸ì¦ ê·¹ë³µ í”„ë¡œê·¸ë¨
   ìœ„ì¹˜: ì„œìš¸ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110
   ```
3. **ì„ë² ë”© ìƒì„±**: OpenAI API í˜¸ì¶œ (text-embedding-3-large)
4. **Qdrant ì €ì¥**: ë²¡í„° + ë©”íƒ€ë°ì´í„° ì €ì¥
5. **ë°°ì¹˜ ì²˜ë¦¬**: 10ê°œì”© ë¬¶ì–´ì„œ ì²˜ë¦¬ (Rate Limit ë°©ì§€)

### ì˜ˆìƒ ì¶œë ¥

```
ğŸš€ ì„¼í„° ì„ë² ë”© ë°°ì¹˜ ì‘ì—… ì‹œì‘...

1ï¸âƒ£  ì„¼í„° ì •ë³´ ì¡°íšŒ ì¤‘...
âœ… ì´ 50ê°œ ì„¼í„° ì¡°íšŒ ì™„ë£Œ

2ï¸âƒ£  ì„ë² ë”© ìƒì„± ì¤‘...

ğŸ“¦ ë°°ì¹˜ 1/5 ì²˜ë¦¬ ì¤‘ (10ê°œ)
âœ… [1430] ì„œìš¸ì‹œë§ˆìŒê±´ê°•ë³µì§€ì„¼í„° (1234ì)
âœ… [1431] ê°•ë‚¨êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (987ì)
âœ… [1432] ì†¡íŒŒêµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1456ì)
âœ… [1433] ì¢…ë¡œêµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1123ì)
âœ… [1434] ë§ˆí¬êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1345ì)
âœ… [1435] ì˜ë“±í¬êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1098ì)
âœ… [1436] ë™ì‘êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1267ì)
âœ… [1437] ê´€ì•…êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1189ì)
âœ… [1438] ì„œì´ˆêµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1421ì)
âœ… [1439] ê°•ë™êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1056ì)

ğŸ“¦ ë°°ì¹˜ 2/5 ì²˜ë¦¬ ì¤‘ (10ê°œ)
âœ… [1440] ìš©ì‚°êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° (1312ì)
...

âœ… ì„¼í„° ì„ë² ë”© ë°°ì¹˜ ì‘ì—… ì™„ë£Œ!

ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:
   - ì´ ì„¼í„° ìˆ˜: 50
   - ì„±ê³µ: 50
   - ì‹¤íŒ¨: 0
   - ì†Œìš” ì‹œê°„: 320ì´ˆ
```

### ì†Œìš” ì‹œê°„ ì˜ˆìƒ

- **ì„¼í„° 10ê°œ**: ì•½ 60ì´ˆ
- **ì„¼í„° 50ê°œ**: ì•½ 300ì´ˆ (5ë¶„)
- **ì„¼í„° 100ê°œ**: ì•½ 600ì´ˆ (10ë¶„)

**ì´ìœ **: OpenAI API Rate Limit (100 requests/minute) + ë°°ì¹˜ ê°„ 1ì´ˆ ëŒ€ê¸°

### CLI ì˜µì…˜

#### íŠ¹ì • ì„¼í„°ë§Œ ì¬ìƒì„±

```bash
# ì„¼í„° ID 1430, 1431, 1432ë§Œ ì¬ìƒì„±
node src/cron/centerEmbeddingBatch.js --ids 1430,1431,1432
```

#### ê°•ì œ ì¬ìƒì„± (ìºì‹œ ë¬´ì‹œ)

```bash
# ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ëª¨ë“  ì„¼í„° ì¬ìƒì„±
node src/cron/centerEmbeddingBatch.js --force
```

#### íŠ¹ì • ì„¼í„° ê°•ì œ ì¬ìƒì„±

```bash
# ì„¼í„° 1430ë§Œ ìºì‹œ ë¬´ì‹œí•˜ê³  ì¬ìƒì„±
node src/cron/centerEmbeddingBatch.js --ids 1430 --force
```

---

## ë¬¸ì œ í•´ê²°

### âŒ Qdrant ì—°ê²° ì‹¤íŒ¨

**ì—ëŸ¬ ë©”ì‹œì§€**:
```
âŒ Qdrant ì—°ê²° ì‹¤íŒ¨: connect ECONNREFUSED 127.0.0.1:6333
```

**í•´ê²° ë°©ë²•**:

1. Qdrant ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸:
   ```bash
   docker ps | grep qdrant
   ```

2. ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ ì‹œì‘:
   ```bash
   docker-compose -f docker-compose.dev.yml up -d qdrant
   ```

3. `.env` íŒŒì¼ì˜ `QDRANT_URL` í™•ì¸:
   ```bash
   # ê°œë°œ í™˜ê²½ (í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰)
   QDRANT_URL=http://localhost:6333

   # Docker ë‚´ë¶€ì—ì„œ ì‹¤í–‰
   QDRANT_URL=http://qdrant:6333
   ```

### âŒ OpenAI API í‚¤ ì˜¤ë¥˜

**ì—ëŸ¬ ë©”ì‹œì§€**:
```
âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
```

**í•´ê²° ë°©ë²•**:

1. `.env` íŒŒì¼ì— API í‚¤ ì¶”ê°€:
   ```bash
   OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx
   ```

2. API í‚¤ê°€ ìœ íš¨í•œì§€ í™•ì¸:
   - https://platform.openai.com/api-keys ì ‘ì†
   - API í‚¤ ìƒíƒœ í™•ì¸ (í™œì„±í™” ì—¬ë¶€)

### âŒ Rate Limit ì´ˆê³¼

**ì—ëŸ¬ ë©”ì‹œì§€**:
```
âŒ [1435] ì˜ë“±í¬êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°: Rate limit exceeded
```

**í•´ê²° ë°©ë²•**:

1. **ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹¤í–‰**: Rate Limitì€ 1ë¶„ë§ˆë‹¤ ë¦¬ì…‹ë©ë‹ˆë‹¤
2. **ì‹¤íŒ¨í•œ ì„¼í„°ë§Œ ì¬ì‹¤í–‰**:
   ```bash
   node src/cron/centerEmbeddingBatch.js --ids 1435,1436,1437
   ```
3. **ìœ ë£Œ í”Œëœ ê³ ë ¤**: OpenAI Tier 1 ì´ìƒì€ 3,500 req/min

### âŒ í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ìŒ

**ê²½ê³  ë©”ì‹œì§€**:
```
âš ï¸  [1440] ìš©ì‚°êµ¬ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°: í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ìŒ (8ì), ìŠ¤í‚µ
```

**ì›ì¸**: ì„¼í„° ì„¤ëª…, í”„ë¡œê·¸ë¨ ì •ë³´ê°€ ê±°ì˜ ì—†ìŒ (10ì ë¯¸ë§Œ)

**í•´ê²° ë°©ë²•**:

1. MySQLì—ì„œ í•´ë‹¹ ì„¼í„° ì •ë³´ í™•ì¸:
   ```sql
   SELECT id, centerName, description, targetGroup, specialization
   FROM Center
   WHERE id = 1440;
   ```

2. ì„¼í„° ì •ë³´ ë³´ì™„ (description, targetGroup, specialization ì¶”ê°€)

3. ì¬ì‹¤í–‰:
   ```bash
   node src/cron/centerEmbeddingBatch.js --ids 1440 --force
   ```

### âŒ ì„¼í„°ê°€ ì¡°íšŒë˜ì§€ ì•ŠìŒ

**ì—ëŸ¬ ë©”ì‹œì§€**:
```
âœ… ì´ 0ê°œ ì„¼í„° ì¡°íšŒ ì™„ë£Œ
âš ï¸  ì²˜ë¦¬í•  ì„¼í„°ê°€ ì—†ìŠµë‹ˆë‹¤
```

**ì›ì¸**: `isActive = false` ë˜ëŠ” ì„¼í„° ë°ì´í„° ì—†ìŒ

**í•´ê²° ë°©ë²•**:

1. MySQLì—ì„œ ì„¼í„° í™•ì¸:
   ```sql
   SELECT COUNT(*) as total,
          SUM(CASE WHEN isActive = 1 THEN 1 ELSE 0 END) as active
   FROM Center;
   ```

2. ì„¼í„°ê°€ ì—†ë‹¤ë©´ ë°ì´í„° ì‚½ì…:
   ```bash
   npm run seed  # ì‹œë“œ ë°ì´í„° ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” ê²½ìš°
   ```

3. `isActive = 0`ì¸ ê²½ìš° í™œì„±í™”:
   ```sql
   UPDATE Center SET isActive = 1 WHERE id IN (1430, 1431, ...);
   ```

---

## ì¶”ê°€ ì‘ì—…

### ì •ê¸° ë°°ì¹˜ ì‘ì—… (Cron)

ì„¼í„° ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ì„ë² ë”©ë„ ì¬ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´:

#### 1. Cron ìŠ¤ì¼€ì¤„ ì„¤ì • (Linux/Mac)

```bash
# crontab í¸ì§‘
crontab -e

# ë§¤ì¼ ìƒˆë²½ 2ì‹œ ì‹¤í–‰
0 2 * * * cd /path/to/backend && node src/cron/centerEmbeddingBatch.js >> /var/log/embedding-batch.log 2>&1
```

#### 2. PM2 ì‚¬ìš© (Node.js í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ì)

```bash
# PM2 ì„¤ì¹˜
npm install -g pm2

# Cron ìŠ¤ì¼€ì¤„ë¡œ ë“±ë¡ (ë§¤ì¼ 02:00)
pm2 start src/cron/centerEmbeddingBatch.js --cron "0 2 * * *" --name "center-embedding-batch"

# ìƒíƒœ í™•ì¸
pm2 list
```

#### 3. Docker Compose (í”„ë¡œë•ì…˜)

`docker-compose.yml`ì— ë³„ë„ ì„œë¹„ìŠ¤ ì¶”ê°€:

```yaml
embedding-batch:
  build:
    context: ./backend
  command: sh -c "while true; do sleep 86400 && node src/cron/centerEmbeddingBatch.js; done"
  depends_on:
    - mysql
    - qdrant
  environment:
    - NODE_ENV=production
    - DATABASE_URL=${DATABASE_URL}
    - OPENAI_API_KEY=${OPENAI_API_KEY}
    - QDRANT_URL=http://qdrant:6333
```

### ì„ë² ë”© í’ˆì§ˆ í™•ì¸

ìƒì„±ëœ ì„ë² ë”©ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸:

```bash
curl -X POST http://localhost:8080/api/v2/recommendations/hybrid \
  -H "Content-Type: application/json" \
  -d '{
    "latitude": 37.5665,
    "longitude": 126.9780,
    "userQuery": "ìš°ìš¸ì¦ ìƒë‹´ì´ í•„ìš”í•´ìš”",
    "maxDistance": 10,
    "limit": 3
  }'
```

**í™•ì¸ ì‚¬í•­**:
- `embeddingScore`: 0.5 ì´ìƒì´ë©´ ì–‘í˜¸
- `matchedKeywords`: ê´€ë ¨ í‚¤ì›Œë“œê°€ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
- `fallbackMode`: `false`ì—¬ì•¼ ì •ìƒ (LLM ì‚¬ìš© ì„±ê³µ)

### ìºì‹œ ê´€ë¦¬

ì„ë² ë”©ì€ Redisì— ìºì‹œë©ë‹ˆë‹¤. ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ë ¤ë©´:

```bash
# Redis CLI ì ‘ì†
docker exec -it mindconnect-redis-dev redis-cli

# ì„ë² ë”© ìºì‹œ ì‚­ì œ
KEYS embedding:*
DEL embedding:openai:hash1 embedding:openai:hash2 ...

# ëª¨ë“  ìºì‹œ ì‚­ì œ (ì£¼ì˜!)
FLUSHDB
```

### ë¹„ìš© ì ˆê° íŒ

OpenAI APIëŠ” ì¢…ëŸ‰ì œì…ë‹ˆë‹¤. ë¹„ìš©ì„ ì ˆê°í•˜ë ¤ë©´:

1. **ìºì‹œ ì ê·¹ í™œìš©**: ë™ì¼í•œ ì¿¼ë¦¬ëŠ” Redisì—ì„œ ê°€ì ¸ì˜´ (ë¬´ë£Œ)
2. **ë°°ì¹˜ ì²˜ë¦¬**: í•œ ë²ˆì— ì—¬ëŸ¬ í…ìŠ¤íŠ¸ ì²˜ë¦¬ (í˜„ì¬ êµ¬í˜„ë¨)
3. **Small ëª¨ë¸ ê³ ë ¤**:
   ```bash
   # .env íŒŒì¼ì—ì„œ
   OPENAI_EMBEDDING_MODEL=text-embedding-3-small  # 1536ì°¨ì› (ì €ë ´)
   # ëŒ€ì‹  QDRANT_VECTOR_SIZE=1536ìœ¼ë¡œ ë³€ê²½ í•„ìš”
   ```
4. **ì„¼í„° ì—…ë°ì´íŠ¸ ì‹œì—ë§Œ ì¬ìƒì„±**: ë¶ˆí•„ìš”í•œ `--force` í”Œë˜ê·¸ ì‚¬ìš© ìì œ

---

## ìš”ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë°°ì¹˜ ì‘ì—… ì™„ë£Œ í›„ í™•ì¸:

- [ ] Qdrant ì»¬ë ‰ì…˜ ìƒì„± ì™„ë£Œ (`node src/scripts/initQdrant.js`)
- [ ] ì„¼í„° ì„ë² ë”© ìƒì„± ì™„ë£Œ (`node src/cron/centerEmbeddingBatch.js`)
- [ ] ì‹¤íŒ¨í•œ ì„¼í„° 0ê°œ (ë˜ëŠ” ì›ì¸ íŒŒì•… í›„ ì¬ì²˜ë¦¬)
- [ ] í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ API í…ŒìŠ¤íŠ¸ ì„±ê³µ (`POST /api/v2/recommendations/hybrid`)
- [ ] `fallbackMode: false` í™•ì¸ (LLM ì •ìƒ ì‘ë™)
- [ ] ì •ê¸° ë°°ì¹˜ ì‘ì—… ì„¤ì • (ì˜µì…˜)

---

## ì°¸ê³  ìë£Œ

- **OpenAI Embedding API**: https://platform.openai.com/docs/guides/embeddings
- **Qdrant ë¬¸ì„œ**: https://qdrant.tech/documentation/
- **Phase 2 Sprint 5 êµ¬í˜„ ê°œìš”**: `context/ê·œì¹™ê¸°ë°˜ì¶”ì²œì‹œìŠ¤í…œ/sprint_5/1.êµ¬í˜„_ê°œìš”.md`

---

**ì‘ì„±ì¼**: 2025-01-13
**ì‘ì„±ì**: Claude (ë§ˆìŒì´ìŒ ê°œë°œíŒ€)
**ë²„ì „**: 1.0.0
