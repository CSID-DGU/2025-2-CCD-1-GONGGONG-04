# 위경도 추출 스크립트

카카오 로컬 API를 사용하여 CSV 파일의 주소 데이터에서 위경도(좌표)를 추출하는 스크립트입니다.

## 기능

- ✅ CSV 파일에서 주소 데이터 읽기
- ✅ **기존 위경도 값이 있는 행은 건너뛰기** (중복 API 호출 방지)
- ✅ 카카오 로컬 API를 통한 주소 → 위경도 변환
- ✅ 도로명 주소 우선, 지번 주소 대체
- ✅ API Rate Limit 자동 조절 (초당 6-7회)
- ✅ 진행 상황 실시간 표시
- ✅ 결과 통계 및 성공/실패/건너뜀 로그
- ✅ UTF-8 BOM 지원 (Excel 호환)

## 사용법

### 기본 사용법

```bash
cd backend
node scripts/extractCoordinates.js <입력파일.csv> <출력파일.csv>
```

### 예시

```bash
# 전국 건강증진센터 데이터 처리
node scripts/extractCoordinates.js \
  ../context/전국건강증진센터표준데이터.csv \
  ../context/전국건강증진센터_위경도포함.csv
```

## 입력 CSV 형식

스크립트는 다음 컬럼을 찾아서 처리합니다:

- `위도`: 기존 위도 값 (있으면 건너뜀)
- `경도`: 기존 경도 값 (있으면 건너뜀)
- `소재지도로명주소`: 도로명 주소 (우선)
- `소재지지번주소`: 지번 주소 (대체)

## 출력 CSV 형식

입력 CSV와 동일한 형식이지만, **위경도가 없는 행에 대해 `위도`, `경도` 컬럼이 채워집니다**:

- `위도`: 카카오 API로 조회한 위도 (latitude) - 기존 값이 있으면 유지
- `경도`: 카카오 API로 조회한 경도 (longitude) - 기존 값이 있으면 유지

**중요**: 기존에 위경도 값이 있는 행은 **건너뛰고** API를 호출하지 않습니다.

## 실행 예시

```bash
$ node scripts/extractCoordinates.js ../context/전국건강증진센터표준데이터.csv output.csv

============================================================
카카오 API 위경도 추출 스크립트
============================================================
입력 파일: /Users/.../전국건강증진센터표준데이터.csv
출력 파일: /Users/.../output.csv
============================================================

[1/4] CSV 파일 읽기 중...
✓ 총 1,234개 행 읽기 완료

[2/4] 카카오 API로 위경도 추출 중...
진행: 1234/1234 (성공: 180, 실패: 54, 건너뜀: 1000)
✓ 위경도 추출 완료

[3/4] 결과 저장 중...
✓ 결과 파일 저장 완료: /Users/.../output.csv

[4/4] 작업 요약
============================================================
총 데이터: 1,234개
기존 데이터 (건너뜀): 1,000개 (81.0%)
API 호출 대상: 234개
  ㄴ 성공: 180개 (76.9%)
  ㄴ 실패: 54개 (23.1%)
============================================================

✅ 작업 완료!
```

## 주요 특징

### 1️⃣ 스마트 건너뛰기 (중복 API 호출 방지)

이미 위경도 값이 있는 행은 자동으로 건너뛰어 불필요한 API 호출을 방지합니다.

```javascript
// 기존 위경도 값 확인
if (existingLat && existingLng && existingLat.trim() !== '' && existingLng.trim() !== '') {
  skipCount++;
  continue; // API 호출 안 함
}
```

**장점**:
- ✅ API 할당량 절약
- ✅ 처리 시간 단축
- ✅ 기존 데이터 보존
- ✅ 재실행 시 누락된 데이터만 보완

### 2️⃣ 자동 Rate Limit 조절

카카오 API는 초당 10회 제한이 있습니다. 스크립트는 자동으로 150ms 딜레이를 적용하여 안전하게 처리합니다.

```javascript
await delay(150); // 초당 약 6-7회로 안전하게 제한
```

### 3️⃣ 도로명/지번 주소 자동 선택

도로명 주소가 있으면 우선 사용하고, 없으면 지번 주소를 사용합니다.

```javascript
const address = roadAddress || jibunAddress;
```

### 4️⃣ 진행 상황 실시간 표시

```
진행: 500/1234 (성공: 480, 실패: 20, 건너뜀: 734)
```

### 5️⃣ Excel 호환 UTF-8 BOM

출력 파일에 UTF-8 BOM을 추가하여 Excel에서 한글이 깨지지 않습니다.

```javascript
fs.writeFileSync(filePath, '\uFEFF' + content, 'utf-8');
```

## API 키 설정

현재 스크립트에는 테스트용 API 키가 하드코딩되어 있습니다:

```javascript
const KAKAO_API_KEY = '5171d4402446ac3ce053e047c8b5c0f7';
```

### 프로덕션 환경에서는

환경변수로 관리하는 것을 권장합니다:

```bash
# .env 파일
KAKAO_REST_API_KEY=your_api_key_here
```

```javascript
// 스크립트 수정
require('dotenv').config();
const KAKAO_API_KEY = process.env.KAKAO_REST_API_KEY;
```

## 오류 처리

스크립트는 다음과 같은 상황에서도 안전하게 작동합니다:

- **주소 없음**: 주소 컬럼이 비어있는 경우 건너뜀
- **검색 결과 없음**: 카카오 API에서 주소를 찾지 못한 경우 위경도 비움
- **API 요청 에러**: 네트워크 오류 시 해당 행 실패 처리
- **기존 데이터 있음**: 위경도가 이미 있으면 건너뜀 (API 호출 안 함)

## 성능

### 기존 데이터가 없는 경우
- **처리 속도**: 약 초당 6-7개 주소
- **100개 주소**: 약 20-25초
- **500개 주소**: 약 1-2분
- **1,000개 주소**: 약 2-3분

### 기존 데이터가 있는 경우 (80% 건너뛰기)
- **1,000개 중 200개만 처리**: 약 30-40초
- **5,000개 중 1,000개만 처리**: 약 2-3분

**💡 팁**: 재실행 시 이미 처리된 데이터는 건너뛰므로 안심하고 여러 번 실행할 수 있습니다!

## 제한사항

- 카카오 API 키 필요 ([카카오 개발자 콘솔](https://developers.kakao.com/)에서 발급)
- 지도/로컬 API 활성화 필요
- 일일 요청 제한 확인 필요 (무료 플랜: 300,000회/일)

## 문제 해결

### "NotAuthorizedError" 오류

카카오 개발자 콘솔에서 **지도/로컬 API**를 활성화하세요.

### "검색 결과 없음" 비율이 높음

- 주소 형식이 정확한지 확인
- 구주소(지번)보다 신주소(도로명)가 정확도가 높음
- 전체 주소 문자열 확인 (특수문자, 오타 등)

### 느린 처리 속도

현재 설정은 API 안정성을 위해 보수적입니다. 속도를 높이려면:

```javascript
await delay(100); // 150ms → 100ms (초당 10회)
```

단, API Rate Limit 초과 시 일시적 차단 가능성이 있습니다.

## 라이선스

MIT License

## 관련 문서

- [카카오 로컬 API 문서](https://developers.kakao.com/docs/latest/ko/local/dev-guide)
- [주소 검색 API](https://developers.kakao.com/docs/latest/ko/local/dev-guide#search-by-address)
